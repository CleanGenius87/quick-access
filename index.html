<!DOCTYPE html>
<!-- Forcing GitHub Pages redeploy to clear cache: 2025-04-29 16:00 BST -->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>First Bus Quick Access & Duty Roster</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
  <style>
    body {
      background: #2c0078;
      font-family: 'Montserrat', Arial, sans-serif;
      color: #fff;
      margin: 0;
      min-height: 100vh;
    }
    .container {
      background: #fff; color: #2c0078; max-width: 520px;
      margin: 64px auto 0 auto; padding: 36px 36px 32px 36px; border-radius: 18px;
      box-shadow: 0 8px 40px rgba(44,0,120,0.11); display: flex; flex-direction: column; align-items: center;
    }
    .logo { width: 180px; margin-bottom: 35px; display: block; }
    .tabs { display: flex; justify-content: center; width: 100%; margin-bottom: 30px; }
    .tab { flex: 1; padding: 13px 0; text-align: center;
      background: #ede7fd; color: #2c0078; font-weight: 600; font-size: 1.04rem;
      cursor: pointer; margin: 0 3px; border-radius: 7px 7px 0 0;
      border-bottom: 3px solid transparent; transition: all 0.12s; outline: none;
    }
    .tab.active { background: #fff; color: #ff44d0; border-bottom: 3px solid #ff44d0; }
    .tab-content { display: none; width: 100%; }
    .tab-content.active { display: block; }
    .dropdown-section, .duty-form-section { width: 100%; margin-bottom: 24px; }
    label { font-weight: bold; margin-bottom: 8px; display: block; font-size: 1.05rem; color: #2c0078;}
    select, input[type="text"], input[type="date"] {
      width: 100%; padding: 10px 12px; border-radius: 7px; border: 1.5px solid #2c0078; font-size: 1rem;
      margin-bottom: 6px; background: #faf7ff; color: #2c0078;
    }
    .actions { margin-top: 14px; width: 100%; display: flex; justify-content: flex-end; }
    button { border: none; border-radius: 6px; padding: 9px 22px; background: #ff44d0; color: #fff;
      font-weight: 600; font-size: 1rem; cursor: pointer; transition: background 0.16s; min-width: 120px;
      box-shadow: 0 2px 10px rgba(44,0,120,0.04);
    }
    button:disabled { background: #c7b2f7; cursor: not-allowed;}
    .duty-list { margin-top: 20px; margin-bottom: 8px; padding-left: 0px; list-style:none;}
    .duty-list li { background: #ede7fd; border-radius: 6px; padding: 9px 14px 7px 14px; margin-bottom: 9px;
      font-size: 1rem; font-weight: 500; color: #36297d;}
    .duty-bulk-form { margin-top: 16px; background: #faf7ff; border-radius: 7px; padding: 16px 10px 7px 10px; margin-bottom: 16px;
      box-shadow: 0 2px 6px rgba(44,0,120,0.04); font-size: 0.98rem; color:#222;}
    .duty-bulk-form table { width: 100%; border-collapse: collapse; margin-top: 8px;}
    .duty-bulk-form th, .duty-bulk-form td { border-bottom: 1px solid #e2e2ee; padding: 6px 4px; text-align: left; font-size: 0.99rem;}
    .duty-bulk-form select { width: 96%; padding: 7px 9px; margin: 0; border-radius: 5px; border: 1.1px solid #bbb; font-size: 0.99rem; background: #fff; color: #251459;}
    .footer { color: #faf7ff99; text-align: center; font-size: 0.93rem; margin-top: 48px;}
    .duty-bulk-form label[for="bulk-name"] {margin-bottom: 11px;}
    .toilet-codes { margin-top: 20px; padding: 10px; background: #ede7fd; border-radius: 6px; }
    .toilet-codes p { margin: 5px 0; font-size: 1rem; color: #36297d; }
    .contact-info { font-size: 0.95rem; color: #d70a33; margin-top: 10px; }
    .handover-content { margin-top: 20px; padding: 10px; background: #ede7fd; border-radius: 6px; width: 100%; }
    .handover-content textarea {
      width: 100%; height: 400px; padding: 10px; border: none; background: transparent;
      font-size: 0.95rem; color: #36297d; resize: none; font-family: 'Montserrat', Arial, sans-serif;
    }
    @media (max-width: 600px) {
      .container {padding: 12px 2vw; max-width: 100vw;}
      .logo {width: 48vw; max-width: 225px;}
      .duty-bulk-form select {width: 99%;}
      .tab { font-size: 0.95rem; padding: 10px 0; }
      .handover-content textarea { height: 300px; font-size: 0.9rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <img src="https://www.firstbus.co.uk/themes/custom/first_bus/logo.svg" class="logo" alt="First Bus Logo">
    <div class="tabs">
      <div class="tab active" data-tab="access">Quick Access</div>
      <div class="tab" data-tab="roster">Duty Roster</div>
      <div class="tab" data-tab="toilet">Toilet Codes</div>
      <div class="tab" data-tab="handover">Midnight Handover</div>
    </div>
    <!-- Tab 1: Quick Access -->
    <div class="tab-content active" id="tab-access">
      <div class="dropdown-section">
        <label for="websiteDropdown">Websites</label>
        <select id="websiteDropdown">
          <option value="">Select a website…</option>
          <option value="https://cv-fleetlink-eu.byd.com/login?redirect=/">BYD FleetLink</option>
          <option value="https://plan.tomtom.com/">TomTom Plan</option>
          <option value="https://one.network/">one.network</option>
          <option value="https://networkmanagementcc.blogspot.com/">Network Management CC Blogspot</option>
          <option value="https://central.greenroad.com/Pages/Login.aspx">GreenRoad Central Login</option>
          <option value="https://bc.tranzaura.com/Login">Tranzaura Login</option>
          <option value="https://selfservice.ratpdev.uk/llubdasweb/web/html/wbsyslogin.r?co=0&lg=0">RATPdev Self Service</option>
          <option value="https://vulcan.ratpdev.com/_dashboards/app/">RATPdev Vulcan Dashboards</option>
        </select>
        <div class="actions">
          <button id="openWebsite" disabled>Open Website</button>
        </div>
      </div>
      <div class="dropdown-section">
        <label for="fileDropdown">Files</label>
        <select id="fileDropdown">
          <option value="">Select a file…</option>
          <option value="files/20050325%20-%20V16%20SIRF%20Template.xlsx">20050325 - V16 SIRF Template (Excel)</option>
          <option value="files/Annual%20Leave%20Request%20Form.docx">Annual Leave Request Form (Word)</option>
          <option value="files/BLANK%20TIMESHEET%20LATEST%20VERSION.xlsm">Blank Timesheet Latest Version (Excel)</option>
          <option value="files/BR43-Blank-form.doc">BR43 - Blank Form (Word)</option>
          <option value="files/Bus%20Running%20Record.pdf">Bus Running Record (PDF)</option>
          <option value="files/Fulwell%20battery%20sheet.xlsx">Fulwell Battery Sheet (Excel)</option>
          <option value="files/IBUS%20Report%20Form%20-%20NEW.xls">IBUS Report Form - NEW (Excel)</option>
          <option value="files/Official-report-blank.xlsm">Official Report Blank (Excel)</option>
        </select>
        <div class="actions">
          <button id="openFile" disabled>Download File</button>
        </div>
      </div>
    </div>

    <!-- Tab 2: Duty Roster -->
    <div class="tab-content" id="tab-roster">
      <div class="actions" style="margin-top:0;margin-bottom:17px;">
        <button id="showBulkDuty">Add My Duties for Month</button>
      </div>
      <div id="bulkDutyFormArea"></div>
      <div style="margin-top:9px;">
        <label for="view-date">See Who’s Working (choose a date):</label>
        <div style="display:flex;align-items:center;gap:10px;">
          <input type="date" id="view-date" style="flex:1;">
          <button id="refreshDuties" style="padding:8px 16px;background:#ff44d0;color:#fff;border-radius:6px;font-size:0.95rem;">Refresh</button>
        </div>
        <ul class="duty-list" id="dutyList"></ul>
      </div>
    </div>

    <!-- Tab 3: Toilet Codes -->
    <div class="tab-content" id="tab-toilet">
      <div class="dropdown-section">
        <label for="toiletLocationDropdown">Select Location</label>
        <select id="toiletLocationDropdown">
          <option value="">Select a location…</option>
          <option value="Acton Green">Acton Green</option>
          <option value="Atkins Road">Atkins Road</option>
          <option value="Belmont">Belmont</option>
          <option value="Bessborough Rd./Alton Rd.">Bessborough Rd./Alton Rd.</option>
          <option value="Brentford County Court">Brentford County Court</option>
          <option value="Brook Street">Brook Street</option>
          <option value="Cane Hill">Cane Hill</option>
          <option value="Camberwell">Camberwell</option>
          <option value="Chessington WOA">Chessington WOA</option>
          <option value="Chiswick Business Park">Chiswick Business Park</option>
          <option value="Clapham Junction">Clapham Junction</option>
          <option value="Cromwell Road">Cromwell Road</option>
          <option value="East Acton, Telford Way">East Acton, Telford Way</option>
          <option value="Ealing Taxi/Bus Stand">Ealing Taxi/Bus Stand</option>
          <option value="Fairfield Bus Station">Fairfield Bus Station</option>
          <option value="Fulwell Stanley Road">Fulwell Stanley Road</option>
          <option value="Great West Quarter">Great West Quarter</option>
          <option value="Ham">Ham</option>
          <option value="Hammersmith Lower">Hammersmith Lower</option>
          <option value="Harrow Bus Station">Harrow Bus Station</option>
          <option value="Kingston - Millennium House">Kingston - Millennium House</option>
          <option value="Lonsdale Road">Lonsdale Road</option>
          <option value="Manor Road">Manor Road</option>
          <option value="Mitcham Fair Green">Mitcham Fair Green</option>
          <option value="Morden">Morden</option>
          <option value="Park Royal ASDA">Park Royal ASDA</option>
          <option value="Pollards Hill">Pollards Hill</option>
          <option value="Putney Bridge">Putney Bridge</option>
          <option value="Richmond Bus Station">Richmond Bus Station</option>
          <option value="Roehampton Bus Station">Roehampton Bus Station</option>
          <option value="Southgate Toilet">Southgate Toilet</option>
          <option value="Staines Elmsleigh Centre">Staines Elmsleigh Centre</option>
          <option value="Sutton Hospital">Sutton Hospital</option>
          <option value="Tolworth (Toby Way)">Tolworth (Toby Way)</option>
          <option value="Tolworth Travel Lodge">Tolworth Travel Lodge</option>
          <option value="Tottenham Hale Bus Station Cabin">Tottenham Hale Bus Station Cabin</option>
          <option value="Turnpike Lane">Turnpike Lane</option>
          <option value="Twickenham Albany">Twickenham Albany</option>
          <option value="Wakefield Road">Wakefield Road</option>
          <option value="Waitrose Twickenham">Waitrose Twickenham</option>
          <option value="Wallington">Wallington</option>
        </select>
        <div class="actions">
          <button id="showToiletCodes" disabled>Show Codes</button>
        </div>
      </div>
      <div id="toiletCodesDisplay" class="toilet-codes" style="display: none;"></div>
      <div class="contact-info">
        For any issues, contact: 07999 405 626
      </div>
    </div>

    <!-- Tab 4: Midnight Handover -->
    <div class="tab-content" id="tab-handover">
      <div class="handover-content">
        <textarea id="handoverText" readonly>Fulwell Midnight Handover

K4, 71, 110, 116, 117, 203, 216, 235, 290, 293, 371, 406, 411, 418, 423, H22, H37, H98

Route: K4
Max delays: minutes
Latest Bus (over stand time): 
Non polling buses: N/A
Missing buses (due to mechanical, incident, staff cut etc): N/A
Late Meal Relief: N/A
Events taking place/due to take place: 

Route: 71
Max delays: minutes
Latest Bus (over stand time): 
Non polling buses: N/A
Missing buses (due to mechanical, incident, staff cut etc): N/A
Late Meal Relief: N/A
Events taking place/due to take place: 

Route: 110
Max delays: minutes
Latest Bus (over stand time): 
Non polling buses: N/A
Missing buses (due to mechanical, incident, staff cut etc): N/A
Late Meal Relief: N/A
Events taking place/due to take place: 

Route: 116
Max delays: minutes
Latest Bus (over stand time): 
Non polling buses: N/A
Missing buses (due to mechanical, incident, staff cut etc): N/A
Late Meal Relief: N/A
Events taking place/due to take place: 

Route: 117
Max delays: minutes
Latest Bus (over stand time): 
Non polling buses: N/A
Missing buses (due to mechanical, incident, staff cut etc): N/A
Late Meal Relief: N/A
Events taking place/due to take place: 

Route: 203
Max delays: minutes
Latest Bus (over stand time): 
Non polling buses: N/A
Missing buses (due to mechanical, incident, staff cut etc): N/A
Late Meal Relief: N/A
Events taking place/due to take place: 

Route: 216
Max delays: minutes
Latest Bus (over stand time): 
Non polling buses: N/A
Missing buses (due to mechanical, incident, staff cut etc): N/A
Late Meal Relief: N/A
Events taking place/due to take place: 

Route: 235
Max delays: minutes
Latest Bus (over stand time): 
Non polling buses: N/A
Missing buses (due to mechanical, incident, staff cut etc): N/A
Late Meal Relief: N/A
Events taking place/due to take place: 

Route: 290
Max delays: minutes
Latest Bus (over stand time): 
Non polling buses: N/A
Missing buses (due to mechanical, incident, staff cut etc): N/A
Late Meal Relief: N/A
Events taking place/due to take place: 

Route: 293
Max delays: minutes
Latest Bus (over stand time): 
Non polling buses: N/A
Missing buses (due to mechanical, incident, staff cut etc): N/A
Late Meal Relief: N/A
Events taking place/due to take place: 

Route: 371
Max delays: minutes
Latest Bus (over stand time): 
Non polling buses: N/A
Missing buses (due to mechanical, incident, staff cut etc): N/A
Late Meal Relief: N/A
Events taking place/due to take place: 

Route: 406
Max delays: minutes
Latest Bus (over stand time): 
Non polling buses: N/A
Missing buses (due to mechanical, incident, staff cut etc): N/A
Late Meal Relief: N/A
Events taking place/due to take place: 

Route: 411
Max delays: minutes
Latest Bus (over stand time): 
Non polling buses: N/A
Missing buses (due to mechanical, incident, staff cut etc): N/A
Late Meal Relief: N/A
Events taking place/due to take place: 

Route: 418
Max delays: minutes
Latest Bus (over stand time): 
Non polling buses: N/A
Missing buses (due to mechanical, incident, staff cut etc): N/A
Late Meal Relief: N/A
Events taking place/due to take place: 

Route: 423
Max delays: minutes
Latest Bus (over stand time): 
Non polling buses: N/A
Missing buses (due to mechanical, incident, staff cut etc): N/A
Late Meal Relief: N/A
Events taking place/due to take place: 

Route: H22
Max delays: minutes
Latest Bus (over stand time): 
Non polling buses: N/A
Missing buses (due to mechanical, incident, staff cut etc): N/A
Late Meal Relief: N/A
Events taking place/due to take place: 

Route: H37
Max delays: minutes
Latest Bus (over stand time): 
Non polling buses: N/A
Missing buses (due to mechanical, incident, staff cut etc): N/A
Late Meal Relief: N/A
Events taking place/due to take place: 

Route: H98
Max delays: minutes
Latest Bus (over stand time): 
Non polling buses: N/A
Missing buses (due to mechanical, incident, staff cut etc): N/A
Late Meal Relief: N/A
Events taking place/due to take place: </textarea>
      </div>
      <div class="actions" style="margin-top: 10px;">
        <button id="copyHandoverText">Copy to Clipboard</button>
      </div>
    </div>

    <div class="footer">
      © First Bus – Quick Access Portal
    </div>
  </div>

  <script>
    // ---------------- Tab UI Logic ----------------
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tabContents.forEach(tc => tc.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
      });
    });

    // ------------ Quick Access Logic -------------
    const siteDd = document.getElementById('websiteDropdown');
    const openWebsiteBtn = document.getElementById('openWebsite');
    siteDd.addEventListener('change', () => {
      openWebsiteBtn.disabled = !siteDd.value;
    });
    openWebsiteBtn.addEventListener('click', () => {
      if (siteDd.value) {
        const link = document.createElement('a');
        link.href = siteDd.value;
        link.target = '_blank';
        link.click();
      }
    });

    const fileDd = document.getElementById('fileDropdown');
    const openFileBtn = document.getElementById('openFile');
    fileDd.addEventListener('change', () => {
      openFileBtn.disabled = !fileDd.value;
    });
    openFileBtn.addEventListener('click', () => {
      if (fileDd.value) {
        const link = document.createElement('a');
        link.href = fileDd.value;
        link.download = '';
        link.click();
      }
    });

    // --------- Duty Roster Logic -----------
    // Google Form URL and field IDs
    const GOOGLE_FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSeQ91haVeFLxHLn1WrwGWNM0vpmAoDfbjaS1AihHYI9s6STOA/formResponse";
    const FORM_FIELD_NAME = "entry.1178796916";
    const FORM_FIELD_DATE = "entry.1742102276";
    const FORM_FIELD_DUTY = "entry.694160622";
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxk_Vyvau86TDQVD1Z4MXEH-ySdTeaBuMUT3N08lc7ibE8gRGc9dXnyVkB3QIzJ9l_d/exec";

    function pad(n) { return n < 10 ? '0' + n : n; }
    function getDateYYYYMMDD(date) {
      return date.getFullYear() + '-' + pad(date.getMonth() + 1) + '-' + pad(date.getDate());
    }
    function dateToDisplay(date) {
      const d = new Date(date);
      return d.toLocaleDateString("en-GB", { weekday: "short", day: "numeric", month: "short" });
    }
    function getNextSaturday() {
      let d = new Date();
      let day = d.getDay();
      let diff = (6 - day);
      let nextSat = new Date(d.getFullYear(), d.getMonth(), d.getDate() + diff);
      return nextSat;
    }
    function setDateLimits() {
      let today = new Date();
      let nextSat = getNextSaturday();
      let minStr = getDateYYYYMMDD(today);
      let maxDay = new Date(nextSat.getFullYear(), nextSat.getMonth(), nextSat.getDate() + 13);
      let maxStr = getDateYYYYMMDD(maxDay);

      document.getElementById('view-date').setAttribute('min', minStr);
      document.getElementById('view-date').setAttribute('max', maxStr);

      let defaultDate = today > nextSat ? today : nextSat;
      document.getElementById('view-date').value = getDateYYYYMMDD(defaultDate);
    }
    setDateLimits();

    // ---- Duty Dropdown Helper ----
    function getDutyOptionsHtml(selectedValue) {
      const duties = [];
      for (let i = 1; i <= 10; i++) {
        duties.push(`FW${i}E`);
        duties.push(`FW${i}L`);
      }
      duties.push('SpareE');
      duties.push('SpareL');
      duties.push('RD');
      duties.push('AH');
      let html = '<option value="">(none)</option>';
      for (const duty of duties) {
        html += `<option value="${duty}" ${(selectedValue === duty) ? "selected" : ""}>${duty}</option>`;
      }
      return html;
    }

    // ------------ Load Duties Using Apps Script -----------------
    async function loadEntries(dateStr) {
      try {
        const url = `${APPS_SCRIPT_URL}?date=${encodeURIComponent(dateStr)}`;
        const response = await fetch(url, { mode: 'cors' });
        if (!response.ok) throw new Error(`Network response was not ok. Status: ${response.status} ${response.statusText}`);
        return await response.json();
      } catch (error) {
        console.error('Error loading entries:', error.message);
        return [];
      }
    }

    // ---- Show Entries for Date (Calls loadEntries) ----
    async function showEntriesForDate(dateStr) {
      const list = document.getElementById('dutyList');
      list.innerHTML = '';
      const entries = await loadEntries(dateStr);
      if (entries.length === 0) {
        list.innerHTML = '<li>No duties recorded for this date.</li>';
      } else {
        entries.sort((a, b) => a.name.localeCompare(b.name));
        entries.forEach(e => {
          const li = document.createElement('li');
          li.textContent = `${e.name}: ${e.duty}`;
          list.appendChild(li);
        });
      }
    }

    document.getElementById('view-date').addEventListener('change', function() {
      showEntriesForDate(this.value);
    });
    showEntriesForDate(document.getElementById('view-date').value);

    document.getElementById('refreshDuties').addEventListener('click', () => {
      const dateInput = document.getElementById('view-date').value;
      if (dateInput) {
        showEntriesForDate(dateInput);
      }
    });

    // ---- Month Selection Helper ----
    function getMonthOptions() {
      const today = new Date();
      const currentYear = today.getFullYear();
      const currentMonth = today.getMonth(); // 0-11
      let options = [];
      // Generate options for the past 12 months and next 12 months
      for (let i = -12; i <= 12; i++) {
        const date = new Date(currentYear, currentMonth + i, 1);
        const year = date.getFullYear();
        const month = date.getMonth(); // 0-11
        const monthName = date.toLocaleString('en-GB', { month: 'long' });
        const value = `${year}-${pad(month + 1)}`; // Format: YYYY-MM
        options.push({ value, label: `${monthName} ${year}` });
      }
      return options;
    }

    function populateMonthDropdown(dropdownId, defaultValue) {
      const dropdown = document.getElementById(dropdownId);
      const options = getMonthOptions();
      dropdown.innerHTML = '<option value="">Select a month…</option>';
      options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt.value;
        option.textContent = opt.label;
        if (opt.value === defaultValue) {
          option.selected = true;
        }
        dropdown.appendChild(option);
      });
    }

    // ---- Bulk Form Logic (Updated for Full Month) ----
    document.getElementById('showBulkDuty').addEventListener('click', function() {
      showBulkForm();
    });

    function showBulkForm() {
      let area = document.getElementById('bulkDutyFormArea');
      let html = `
      <div class="duty-bulk-form">
        <label for="bulk-month">Select Month</label>
        <select id="bulk-month"></select>
        <div id="bulkDutyTable"></div>
        <div class="actions" style="margin-top:17px;">
          <button id="saveDuties" type="button">Save All Duties</button>
          <button id="clearForm" type="button" style="margin-left:12px;background:#ff4444;color:#fff;">Clear Form</button>
          <button id="cancelBulk" type="button" style="margin-left:12px;background:#bbb;color:#2c0078;">Cancel</button>
        </div>
        <div id="submitStatus" style="margin:7px 0 0 0;font-size:0.98em;"></div>
      </div>
      `;
      area.innerHTML = html;

      // Populate the month dropdown with the current month as default
      const today = new Date();
      const defaultMonth = `${today.getFullYear()}-${pad(today.getMonth() + 1)}`;
      populateMonthDropdown('bulk-month', defaultMonth);

      // Update the table when the month changes
      document.getElementById('bulk-month').addEventListener('change', function() {
        updateBulkDutyTable(this.value);
      });

      // Initial table population
      updateBulkDutyTable(defaultMonth);

      document.getElementById('cancelBulk').onclick = () => { area.innerHTML = ''; };

      // Clear form button logic
      document.getElementById('clearForm').onclick = () => {
        document.getElementById('bulk-name').value = '';
        const selects = document.querySelectorAll('#bulkDutyTable select');
        selects.forEach(select => {
          select.value = '';
        });
        document.getElementById('submitStatus').textContent = '';
      };
    }

    function updateBulkDutyTable(monthValue) {
      if (!monthValue) {
        document.getElementById('bulkDutyTable').innerHTML = '<p>Please select a month.</p>';
        return;
      }

      const [year, month] = monthValue.split('-').map(Number); // e.g., "2025-04" -> [2025, 4]
      const startDate = new Date(year, month - 1, 1); // Month is 0-indexed in JS
      const endDate = new Date(year, month, 0); // Last day of the month
      const daysInMonth = endDate.getDate();
      let days = [];

      // Generate all dates in the month
      for (let i = 1; i <= daysInMonth; i++) {
        let d = new Date(year, month - 1, i);
        days.push({
          date: getDateYYYYMMDD(d),
          display: dateToDisplay(d)
        });
      }

      // Build the table
      let tableHtml = `
        <label for="bulk-name" style="margin-top:12px;">Your Name</label>
        <input type="text" id="bulk-name" maxlength="36" autocomplete="off" placeholder="e.g. Chris B" required>
        <table>
          <thead><tr><th>Date</th><th>Duty</th></tr></thead>
          <tbody>
      `;
      days.forEach((d, i) => {
        tableHtml += `
          <tr>
            <td><b>${d.display}</b><br><small>${d.date}</small></td>
            <td>
              <select id="bulk-duty-${i}">
                ${getDutyOptionsHtml("")}
              </select>
            </td>
          </tr>
        `;
      });
      tableHtml += `
          </tbody>
        </table>
      `;
      document.getElementById('bulkDutyTable').innerHTML = tableHtml;

      // Save duties
      document.getElementById('saveDuties').onclick = async function() {
        let name = document.getElementById('bulk-name').value.trim();
        if (!name) {
          alert('Please enter your name.');
          return;
        }
        let newEntries = [];
        for (let i = 0; i < days.length; i++) {
          let dutySel = document.getElementById('bulk-duty-' + i);
          let duty = dutySel.value;
          if (duty) {
            newEntries.push({ name, date: days[i].date, duty });
          }
        }
        if (newEntries.length === 0) {
          alert("No duties entered. Please fill at least one!");
          return;
        }

        let submitStatus = document.getElementById('submitStatus');
        submitStatus.textContent = "Submitting to rota sheet…";
        submitStatus.style.color = "#836cf4";
        let successCount = 0;
        for (let entry of newEntries) {
          const formData = new FormData();
          formData.append(FORM_FIELD_NAME, entry.name);
          formData.append(FORM_FIELD_DATE, entry.date);
          formData.append(FORM_FIELD_DUTY, entry.duty);
          try {
            const response = await fetch(GOOGLE_FORM_URL, {
              method: 'POST',
              body: formData,
              mode: 'no-cors'
            });
            successCount++;
          } catch (error) {
            console.error('Error submitting duty:', error);
            submitStatus.textContent = "❌ Error saving to rota sheet.";
            submitStatus.style.color = "#d70a33";
            return;
          }
        }
        if (successCount === newEntries.length) {
          submitStatus.textContent = "✅ Rota duties saved to rota sheet!";
          submitStatus.style.color = "#44b261";
          setTimeout(() => { document.getElementById('bulkDutyFormArea').innerHTML = ''; }, 1200);
          let currView = document.getElementById('view-date').value;
          if (currView && newEntries.some(en => en.date === currView)) {
            showEntriesForDate(currView);
          }
        } else {
          submitStatus.textContent = "❌ Some duties failed to save.";
          submitStatus.style.color = "#d70a33";
        }
      };
    }

    // --------- Toilet Codes Logic -----------
    const toiletCodesData = [
      { location: "Acton Green", mainDoor: "7469", gents: "", ladies: "", keyLockBox: "" },
      { location: "Atkins Road", mainDoor: "5+4 2 1", gents: "", ladies: "", keyLockBox: "" },
      { location: "Belmont", mainDoor: "5603", gents: "", ladies: "", keyLockBox: "" },
      { location: "Bessborough Rd./Alton Rd.", mainDoor: "C8046X", gents: "", ladies: "", keyLockBox: "" },
      { location: "Brentford County Court", mainDoor: "235", gents: "", ladies: "C1953X", keyLockBox: "" },
      { location: "Brook Street", mainDoor: "5617", gents: "", ladies: "", keyLockBox: "Temporary toilet code: C1234Z" },
      { location: "Cane Hill", mainDoor: "C4590X", gents: "", ladies: "", keyLockBox: "" },
      { location: "Camberwell", mainDoor: "1403", gents: "", ladies: "", keyLockBox: "" },
      { location: "Chessington WOA", mainDoor: "", gents: "C1652Z", ladies: "C8925X", keyLockBox: "" },
      { location: "Chiswick Business Park", mainDoor: "1+5 4", gents: "", ladies: "2314", keyLockBox: "" },
      { location: "Clapham Junction", mainDoor: "2+4 1+5 3", gents: "", ladies: "", keyLockBox: "" },
      { location: "Cromwell Road", mainDoor: "B83790", gents: "4+2, 5, 3", ladies: "2+3, 4, 1", keyLockBox: "" },
      { location: "East Acton, Telford Way", mainDoor: "", gents: "2471", ladies: "2947", keyLockBox: "" },
      { location: "Ealing Taxi/Bus Stand", mainDoor: "5116", gents: "", ladies: "", keyLockBox: "" },
      { location: "Fairfield Bus Station", mainDoor: "5+3, 2, 1", gents: "", ladies: "", keyLockBox: "" },
      { location: "Fulwell Stanley Road", mainDoor: "1702", gents: "1702", ladies: "C6740Z", keyLockBox: "" },
      { location: "Great West Quarter", mainDoor: "1+5, 1", gents: "", ladies: "1+2, 4, 3", keyLockBox: "" },
      { location: "Ham", mainDoor: "C3470X", gents: "", ladies: "", keyLockBox: "" },
      { location: "Hammersmith Lower", mainDoor: "2+3, 5, 4, 1", gents: "", ladies: "", keyLockBox: "" },
      { location: "Harrow Bus Station", mainDoor: "C1209X", gents: "", ladies: "", keyLockBox: "" },
      { location: "Kingston - Millennium House", mainDoor: "C1987", gents: "", ladies: "1987", keyLockBox: "" },
      { location: "Lonsdale Road", mainDoor: "3470X", gents: "", ladies: "", keyLockBox: "" },
      { location: "Manor Road", mainDoor: "1468Y", gents: "", ladies: "", keyLockBox: "" },
      { location: "Mitcham Fair Green", mainDoor: "", gents: "5+2 1 4", ladies: "", keyLockBox: "" },
      { location: "Morden", mainDoor: "C3490X", gents: "", ladies: "", keyLockBox: "" },
      { location: "Park Royal ASDA", mainDoor: "1048 / 1987", gents: "", ladies: "", keyLockBox: "" },
      { location: "Pollards Hill", mainDoor: "1203", gents: "", ladies: "", keyLockBox: "" },
      { location: "Putney Bridge", mainDoor: "3470X", gents: "", ladies: "", keyLockBox: "" },
      { location: "Richmond Bus Station", mainDoor: "1+2, 3+5, 4", gents: "2512", ladies: "6113", keyLockBox: "Temp Toilet C3470" },
      { location: "Roehampton Bus Station", mainDoor: "C3470X", gents: "", ladies: "", keyLockBox: "" },
      { location: "Southgate Toilet", mainDoor: "", gents: "", ladies: "C2581Y", keyLockBox: "" },
      { location: "Staines Elmsleigh Centre", mainDoor: "7532", gents: "1473", ladies: "1473", keyLockBox: "Back door code 2704 driver give code on 25/03/2024" },
      { location: "Sutton Hospital", mainDoor: "2+5 1", gents: "", ladies: "", keyLockBox: "" },
      { location: "Tolworth (Toby Way)", mainDoor: "C3460X", gents: "", ladies: "", keyLockBox: "" },
      { location: "Tolworth Travel Lodge", mainDoor: "C3470X", gents: "", ladies: "", keyLockBox: "" },
      { location: "Tottenham Hale Bus Station Cabin", mainDoor: "3470X", gents: "", ladies: "", keyLockBox: "" },
      { location: "Turnpike Lane", mainDoor: "2351X", gents: "", ladies: "", keyLockBox: "" },
      { location: "Twickenham Albany", mainDoor: "", gents: "6912", ladies: "5831", keyLockBox: "" },
      { location: "Wakefield Road", mainDoor: "", gents: "", ladies: "8205", keyLockBox: "" },
      { location: "Waitrose Twickenham", mainDoor: "60369X", gents: "", ladies: "", keyLockBox: "" },
      { location: "Wallington", mainDoor: "2 5+3", gents: "", ladies: "2703", keyLockBox: "" }
    ];

    const toiletLocationDd = document.getElementById('toiletLocationDropdown');
    const showToiletCodesBtn = document.getElementById('showToiletCodes');
    const toiletCodesDisplay = document.getElementById('toiletCodesDisplay');

    toiletLocationDd.addEventListener('change', () => {
      showToiletCodesBtn.disabled = !toiletLocationDd.value;
      toiletCodesDisplay.style.display = 'none'; // Hide display when changing selection
    });

    showToiletCodesBtn.addEventListener('click', () => {
      const selectedLocation = toiletLocationDd.value;
      if (!selectedLocation) return;

      const locationData = toiletCodesData.find(item => item.location === selectedLocation);
      if (!locationData) {
        toiletCodesDisplay.innerHTML = '<p>No codes available for this location.</p>';
        toiletCodesDisplay.style.display = 'block';
        return;
      }

      let html = '';
      if (locationData.mainDoor) html += `<p><strong>Main Door:</strong> ${locationData.mainDoor}</p>`;
      if (locationData.gents) html += `<p><strong>Gents:</strong> ${locationData.gents}</p>`;
      if (locationData.ladies) html += `<p><strong>Ladies:</strong> ${locationData.ladies}</p>`;
      if (locationData.keyLockBox) html += `<p><strong>Key Lock Box:</strong> ${locationData.keyLockBox}</p>`;

      toiletCodesDisplay.innerHTML = html || '<p>No codes available for this location.</p>';
      toiletCodesDisplay.style.display = 'block';
    });

    // --------- Midnight Handover Logic -----------
    const copyHandoverBtn = document.getElementById('copyHandoverText');
    const handoverTextArea = document.getElementById('handoverText');

    copyHandoverBtn.addEventListener('click', () => {
      handoverTextArea.select();
      try {
        document.execCommand('copy');
        copyHandoverBtn.textContent = 'Copied!';
        copyHandoverBtn.style.background = '#44b261';
        setTimeout(() => {
          copyHandoverBtn.textContent = 'Copy to Clipboard';
          copyHandoverBtn.style.background = '#ff44d0';
        }, 2000);
      } catch (err) {
        console.error('Failed to copy text: ', err);
        copyHandoverBtn.textContent = 'Copy Failed';
        copyHandoverBtn.style.background = '#d70a33';
      }
    });

    // --------- Hidden Alarm Feature: Trigger at 18:30 Daily -----------
    let lastAlarmDate = null;

    function checkAlarm() {
      const now = new Date();
      const hours = now.getHours();
      const minutes = now.getMinutes();
      const currentDate = getDateYYYYMMDD(now);

      // Check if it's 18:30 and we haven't triggered the alarm today
      if (hours === 18 && minutes === 30 && lastAlarmDate !== currentDate) {
        alert("MOVE YOUR CAR");
        lastAlarmDate = currentDate; // Update the last alarm date to prevent multiple triggers
      }
    }

    // Check the time every minute (60,000 milliseconds)
    setInterval(checkAlarm, 60000);

    // Run the check immediately in case the app is opened exactly at 18:30
    checkAlarm();
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'936ff448cb61bff2',t:'MTc0NTc3NDA0NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
